<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Likert - Ajustado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header-card { background: #1e293b; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
        input { width: 60%; padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { padding: 12px 25px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .dimension-section { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 40px; 
            /* Altura fixa para evitar que o gráfico se estique verticalmente */
            height: 550px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .dim-title { color: #1e293b; text-align: center; margin-bottom: 10px; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <h2>Dashboard Analítico: Pergunta a Pergunta</h2>
        <div style="display:flex; gap:10px; justify-content: center;">
            <input type="text" id="urlInput" placeholder="Link CSV da Planilha Pública">
            <button onclick="carregarDados()">Gerar Dashboard</button>
        </div>
    </div>
    <div id="chartsArea"></div>
</div>

<script>
    Chart.register(ChartDataLabels);
    let instanciasGraficos = [];

    // Cores: Verde (5) -> Vermelho (0)
    const labelsEscala = ["5 - Muito Feliz", "4", "3", "2", "1", "0 - Infeliz"];
    const coresLikert = ["#16a34a", "#4ade80", "#facc15", "#f87171", "#ef4444", "#dc2626"];

    async function carregarDados() {
        const url = document.getElementById('urlInput').value;
        if (!url) return alert("Insira o link!");
        try {
            const response = await fetch(url);
            const text = await response.text();
            const linhas = text.split('\n').filter(l => l.trim() !== '').map(l => l.split(','));
            const cabecalho = linhas[0];
            const dados = linhas.slice(1).map(l => l.map(n => parseInt(n.trim())));
            processarDimensoes(cabecalho, dados);
        } catch (e) { alert("Erro ao carregar CSV."); }
    }

    function processarDimensoes(cabecalho, dados) {
        const area = document.getElementById('chartsArea');
        area.innerHTML = ''; 
        instanciasGraficos.forEach(g => g.destroy());
        instanciasGraficos = [];

        const configuracao = [
            { nome: "Dimensão 1", cols: [2, 3, 4, 5, 6, 7] },
            { nome: "Dimensão 2", cols: [8, 9, 10, 11, 12] },
            { nome: "Dimensão 3", cols: [13, 14, 15, 16, 17] }
        ];

        configuracao.forEach((dim, index) => {
            const section = document.createElement('div');
            section.className = 'dimension-section';
            section.innerHTML = `<div class="dim-title">${dim.nome}</div><div style="height:90%"><canvas id="canvas-${index}"></canvas></div>`;
            area.appendChild(section);

            const labelsPerguntas = dim.cols.map((c, i) => `Pergunta ${i + 1}`);

            const datasets = labelsEscala.map((label, idxEscala) => {
                const valorAlvo = 5 - idxEscala;
                return {
                    label: label,
                    data: dim.cols.map(colIdx => {
                        const totalRespostasValidas = dados.filter(row => !isNaN(row[colIdx])).length;
                        const contagem = dados.filter(row => row[colIdx] === valorAlvo).length;
                        return totalRespostasValidas > 0 ? parseFloat(((contagem / totalRespostasValidas) * 100).toFixed(1)) : 0;
                    }),
                    backgroundColor: coresLikert[idxEscala],
                    barPercentage: 0.8, // Controla a largura da barra individual
                    categoryPercentage: 0.9 // Controla o espaço da categoria
                };
            });

            renderizar(index, labelsPerguntas, datasets);
        });
    }

    function renderizar(idx, labels, datasets) {
        const ctx = document.getElementById(`canvas-${idx}`).getContext('2d');
        const novoGrafico = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { bottom: 20 } // Espaço extra para a legenda
                },
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 15, font: { size: 11 }, color: '#334155' } 
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value > 3 ? value + '%' : '', // Oculta se for muito pequeno para não embolar
                        anchor: 'center',
                        align: 'center'
                    }
                },
                scales: {
                    x: { 
                        stacked: true, 
                        max: 100, 
                        ticks: { color: '#334155' },
                        grid: { display: false }
                    },
                    y: { 
                        stacked: true, 
                        ticks: { color: '#1e293b', font: { weight: 'bold' } },
                        grid: { display: false }
                    }
                }
            }
        });
        instanciasGraficos.push(novoGrafico);
    }
</script>

</body>
</html>
