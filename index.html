<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Análise Avançada Likert - Dimensões</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .config-card { background: #1e293b; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        input { width: 60%; padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; margin-right: 10px; }
        button { padding: 12px 25px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; min-height: 400px; }
        .full-width { grid-column: span 2; }
        
        h2 { color: #60a5fa; margin-top: 0; }
        label { display: block; margin-bottom: 10px; color: #94a3b8; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-card">
        <h2>Dashboard de Pesquisa Acadêmica</h2>
        <label>Insira o link CSV da sua Planilha do Google (Publicada na Web)</label>
        <input type="text" id="urlInput" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
        <button onclick="carregarDados()">Gerar Análise</button>
    </div>

    <div class="grid-charts">
        <div class="chart-box full-width">
            <canvas id="chartDimensoes"></canvas>
        </div>

        <div class="chart-box">
            <canvas id="chartRadar"></canvas>
        </div>

        <div class="chart-box">
            <canvas id="chartIdade"></canvas>
        </div>
    </div>
</div>

<script>
    let charts = {};

    async function carregarDados() {
        const url = document.getElementById('urlInput').value;
        if (!url) return alert("Insira o link!");

        try {
            const response = await fetch(url);
            const text = await response.text();
            const linhas = text.split('\n').filter(l => l.trim() !== '').map(l => l.split(','));
            
            // Converte tudo para número, limpando espaços
            const dados = linhas.slice(1).map(l => l.map(n => parseFloat(n.trim())));
            processarEstatisticas(dados);
        } catch (e) {
            alert("Erro ao processar dados. Verifique se a planilha está pública e no formato correto.");
        }
    }

    function processarEstatisticas(dados) {
        // Definição das colunas conforme seu pedido (índice começa em 0)
        const colIdade = 0;
        const colGenero = 1;
        const colsD1 = [2, 3, 4, 5, 6, 7];   // Colunas 3 a 8
        const colsD2 = [8, 9, 10, 11, 12];   // Colunas 9 a 13
        const colsD3 = [13, 14, 15, 16, 17]; // Colunas 14 a 18

        const calcMedia = (row, cols) => {
            const vals = cols.map(c => row[c]).filter(v => !isNaN(v));
            return vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
        };

        const masc = dados.filter(d => d[colGenero] === 1);
        const fem = dados.filter(d => d[colGenero] === 2);

        const labels = ["Dimensão 1", "Dimensão 2", "Dimensão 3"];
        
        const getMediasGrupo = (grupo) => [
            (grupo.reduce((acc, row) => acc + calcMedia(row, colsD1), 0) / grupo.length || 0).toFixed(2),
            (grupo.reduce((acc, row) => acc + calcMedia(row, colsD2), 0) / grupo.length || 0).toFixed(2),
            (grupo.reduce((acc, row) => acc + calcMedia(row, colsD3), 0) / grupo.length || 0).toFixed(2)
        ];

        const mediasMasc = getMediasGrupo(masc);
        const mediasFem = getMediasGrupo(fem);

        // Dados para correlação Idade vs Média Total
        const dadosIdade = dados.map(row => ({
            x: row[colIdade],
            y: calcMedia(row, [...colsD1, ...colsD2, ...colsD3]).toFixed(2)
        }));

        renderizarGraficos(labels, mediasMasc, mediasFem, dadosIdade);
    }

    function renderizarGraficos(labels, m, f, dadosIdade) {
        // Limpar gráficos anteriores se existirem
        Object.values(charts).forEach(c => c.destroy());

        const ctxBar = document.getElementById('chartDimensoes').getContext('2d');
        charts.bar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Masculino', data: m, backgroundColor: '#3b82f6' },
                    { label: 'Feminino', data: f, backgroundColor: '#ec4899' }
                ]
            },
            options: { plugins: { title: { display: true, text: 'Médias por Dimensão e Gênero' } }, scales: { y: { max: 5, beginAtZero: true } } }
        });

        const ctxRadar = document.getElementById('chartRadar').getContext('2d');
        charts.radar = new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Masc', data: m, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)' },
                    { label: 'Fem', data: f, borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.2)' }
                ]
            },
            options: { scales: { r: { max: 5, beginAtZero: true } } }
        });

        const ctxIdade = document.getElementById('chartIdade').getContext('2d');
        charts.idade = new Chart(ctxIdade, {
            type: 'scatter',
            data: {
                datasets: [{ label: 'Idade vs Satisfação', data: dadosIdade, backgroundColor: '#6366f1' }]
            },
            options: {
                plugins: { title: { display: true, text: 'Correlação: Idade x Satisfação Geral' } },
                scales: { x: { title: { display: true, text: 'Idade' } }, y: { min: 1, max: 5 } }
            }
        });
    }
</script>

</body>
</html>
