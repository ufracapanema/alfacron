<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Análise Detalhada - Dashboard Likert</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .header-card { background: #1e293b; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
        input { width: 60%; padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { padding: 12px 25px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* Aumentado o min-height e padding para a legenda não cortar */
        .dimension-section { background: white; padding: 20px 20px 60px 20px; border-radius: 12px; margin-bottom: 40px; min-height: 500px; }
        .dim-title { color: #1e293b; text-align: center; margin-bottom: 15px; font-weight: 800; text-transform: uppercase; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <h2>Dashboard Analítico: Pergunta a Pergunta</h2>
        <div style="display:flex; gap:10px; justify-content: center;">
            <input type="text" id="urlInput" placeholder="Link CSV da Planilha Pública">
            <button onclick="carregarDados()">Gerar Dashboard</button>
        </div>
    </div>

    <div id="chartsArea"></div>
</div>

<script>
    // Registrar o plugin de rótulos globais
    Chart.register(ChartDataLabels);

    let instanciasGraficos = [];
    const labelsEscala = ["5 - Muito Feliz", "4", "3", "2", "1", "0 - Infeliz"];
    const coresLikert = ["#16a34a", "#4ade80", "#facc15", "#f87171", "#ef4444", "#dc2626"];

    async function carregarDados() {
        const url = document.getElementById('urlInput').value;
        if (!url) return alert("Insira o link!");
        try {
            const response = await fetch(url);
            const text = await response.text();
            const linhas = text.split('\n').filter(l => l.trim() !== '').map(l => l.split(','));
            const cabecalho = linhas[0];
            const dados = linhas.slice(1).map(l => l.map(n => parseInt(n.trim())));
            processarDimensoes(cabecalho, dados);
        } catch (e) { alert("Erro ao carregar CSV."); }
    }

    function processarDimensoes(cabecalho, dados) {
        const area = document.getElementById('chartsArea');
        area.innerHTML = ''; 
        instanciasGraficos.forEach(g => g.destroy());
        instanciasGraficos = [];

        const configuracao = [
            { nome: "Dimensão 1", cols: [2, 3, 4, 5, 6, 7] },
            { nome: "Dimensão 2", cols: [8, 9, 10, 11, 12] },
            { nome: "Dimensão 3", cols: [13, 14, 15, 16, 17] }
        ];

        configuracao.forEach((dim, index) => {
            const section = document.createElement('div');
            section.className = 'dimension-section';
            section.innerHTML = `<div class="dim-title">${dim.nome}</div><canvas id="canvas-${index}"></canvas>`;
            area.appendChild(section);

            const labelsPerguntas = dim.cols.map((c, i) => `P${i + 1}`);

            const datasets = labelsEscala.map((label, idxEscala) => {
                const valorAlvo = 5 - idxEscala;
                return {
                    label: label,
                    data: dim.cols.map(colIdx => {
                        const total = dados.length;
                        const contagem = dados.filter(row => row[colIdx] === valorAlvo).length;
                        return parseFloat(((contagem / total) * 100).toFixed(1));
                    }),
                    backgroundColor: coresLikert[idxEscala]
                };
            });

            renderizar(index, labelsPerguntas, datasets);
        });
    }

    function renderizar(idx, labels, datasets) {
        const ctx = document.getElementById(`canvas-${idx}`).getContext('2d');
        const novoGrafico = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 12, font: { size: 10 }, color: '#334155', padding: 20 } 
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        formatter: (value) => value > 5 ? value + '%' : '', // Só mostra se a fatia for maior que 5%
                    }
                },
                scales: {
                    x: { stacked: true, max: 100, ticks: { color: '#334155' } },
                    y: { stacked: true, ticks: { color: '#334155', font: { weight: 'bold' } } }
                }
            }
        });
        instanciasGraficos.push(novoGrafico);
    }
</script>

</body>
</html>
